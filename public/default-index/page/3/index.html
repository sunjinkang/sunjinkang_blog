<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"sunjinkang.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.12.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Sun ...something">
<meta property="og:url" content="https://sunjinkang.github.io/default-index/page/3/index.html">
<meta property="og:site_name" content="Sun ...something">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Sun Jinkang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://sunjinkang.github.io/default-index/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"default-index/page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Sun ...something - about what I have learned and some interesting things</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Sun ...something" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Sun ...something</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">about what I have learned and some interesting things</p>
      <img class="custom-logo-image" src="/images/logo.jpeg" alt="Sun ...something">
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-vue"><a href="/vue/" rel="section"><i class="fa fa-archive fa-fw"></i>vue</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Sun Jinkang"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Sun Jinkang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sunjinkang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sunjinkang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2060037942@qq.com" title="E-Mail → mailto:2060037942@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/Readme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/Readme/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Co"><a href="#Co" class="headerlink" title="Co"></a>Co</h1><p>  <a target="_blank" rel="noopener" href="https://travis-ci.org/visionmedia/co"><img src="https://travis-ci.org/visionmedia/co.svg?branch=master" alt="Build Status"></a></p>
<p>  Generator based flow-control goodness for nodejs and the browser, using<br>  thunks <em>or</em> promises, letting you write non-blocking code in a nice-ish<br>  way.</p>
<p>  Co is careful to relay any errors that occur back to the generator, including those<br>  within the thunk, or from the thunk’s callback. “Uncaught” exceptions in the generator<br>  are passed to <code>co()</code>‘s thunk.</p>
<p>  Make sure to view the <a target="_blank" rel="noopener" href="https://github.com/visionmedia/co/tree/master/examples">examples</a>.</p>
<h2 id="Platform-Compatibility"><a href="#Platform-Compatibility" class="headerlink" title="Platform Compatibility"></a>Platform Compatibility</h2><p>  When using node 0.11.x or greater, you must use the <code>--harmony-generators</code><br>  flag or just <code>--harmony</code> to get access to generators.</p>
<p>  When using node 0.10.x and lower or browsers without generator support,<br>  you must use <a target="_blank" rel="noopener" href="https://github.com/TooTallNate/gnode">gnode</a> and/or <a target="_blank" rel="noopener" href="http://facebook.github.io/regenerator/">regenerator</a>.</p>
<p>  When using node 0.8.x and lower or browsers without <code>setImmediate</code>,<br>  you must include a <code>setImmediate</code> polyfill.<br>  For a really simple polyfill, you may use <a target="_blank" rel="noopener" href="https://github.com/component/setimmediate.js">component/setimmediate.js</a>.<br>  For a more robust polyfill, you may use <a target="_blank" rel="noopener" href="https://github.com/YuzuJS/setImmediate">YuzuJS/setImmediate</a>.</p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install co</span><br></pre></td></tr></table></figure>

<h2 id="Associated-libraries"><a href="#Associated-libraries" class="headerlink" title="Associated libraries"></a>Associated libraries</h2><p>  View the <a target="_blank" rel="noopener" href="https://github.com/visionmedia/co/wiki">wiki</a> for libraries that<br>  work well with Co.</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> thunkify = <span class="built_in">require</span>(<span class="string">&#x27;thunkify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> get = <span class="title function_">thunkify</span>(request.<span class="property">get</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;http://cloudup.com&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">0</span>].<span class="property">statusCode</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(b[<span class="number">0</span>].<span class="property">statusCode</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(c[<span class="number">0</span>].<span class="property">statusCode</span>);</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">get</span>(<span class="string">&#x27;http://cloudup.com&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">&#125;)()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Error handling</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;http://badhost.invalid&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">code</span>) <span class="comment">// ENOTFOUND</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h2 id="Yieldables"><a href="#Yieldables" class="headerlink" title="Yieldables"></a>Yieldables</h2><p>  The “yieldable” objects currently supported are:</p>
<ul>
<li>promises</li>
<li>thunks (functions)</li>
<li>array (parallel execution)</li>
<li>objects (parallel execution)</li>
<li>generators (delegation)</li>
<li>generator functions (delegation)</li>
</ul>
<p>To convert a regular node function that accepts a callback into one which returns a thunk you may want to use <a target="_blank" rel="noopener" href="https://github.com/visionmedia/node-thunkify">thunkify</a> or similar.</p>
<h2 id="Thunks-vs-promises"><a href="#Thunks-vs-promises" class="headerlink" title="Thunks vs promises"></a>Thunks vs promises</h2><p>  While co supports promises, you may return “thunks” from your functions,<br>  which otherwise behaves just like the traditional node-style callback<br>  with a signature of: <code>(err, result)</code>.</p>
<p>  For example take <code>fs.readFile</code>, we all know the signature is:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readFile</span>(path, encoding, <span class="keyword">function</span>(<span class="params">err, result</span>)&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>  To work with Co we need a function to return another function of<br>  the same signature:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">readFile</span>(path, encoding)(<span class="keyword">function</span>(<span class="params">err, result</span>)&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>  Which basically looks like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">path, encoding</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">cb</span>)&#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(path, encoding, cb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  or to execute immediately like this (see <a target="_blank" rel="noopener" href="https://github.com/visionmedia/node-thunkify"><code>thunkify</code></a>):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">path, encoding</span>) &#123;</span><br><span class="line">  <span class="comment">// call fs.readFile immediately, store result later</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">cb</span>)&#123;</span><br><span class="line">    <span class="comment">// cb(err, result) or when result ready</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Receiver-propagation"><a href="#Receiver-propagation" class="headerlink" title="Receiver propagation"></a>Receiver propagation</h2><p>  When <code>co</code> is invoked with a receiver it will propagate to most yieldables,<br>  allowing you to alter <code>this</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ctx = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="variable language_">this</span> == ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="variable language_">this</span> == ctx);</span><br><span class="line">  <span class="keyword">yield</span> foo;</span><br><span class="line">&#125;).<span class="title function_">call</span>(ctx)</span><br></pre></td></tr></table></figure>

<p>  You also pass arguments through the generator:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *(a)&#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="variable language_">this</span> == ctx);</span><br><span class="line">  <span class="title function_">assert</span>(<span class="string">&#x27;yay&#x27;</span> == a);</span><br><span class="line">  <span class="keyword">yield</span> foo;</span><br><span class="line">&#125;).<span class="title function_">call</span>(ctx, <span class="string">&#x27;yay&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="co-fn"><a href="#co-fn" class="headerlink" title="co(fn)"></a>co(fn)</h3><p>  Pass a generator <code>fn</code> and return a thunk. The thunk’s signature is<br>  <code>(err, result)</code>, where <code>result</code> is the value passed to the <code>return</code><br>  statement.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(file, <span class="string">&#x27;utf8&#x27;</span>, fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> <span class="title function_">read</span>(<span class="string">&#x27;.gitignore&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> <span class="title function_">read</span>(<span class="string">&#x27;Makefile&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">yield</span> <span class="title function_">read</span>(<span class="string">&#x27;package.json&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> [a, b, c];</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  You may also yield <code>Generator</code> objects to support nesting:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">size</span>(<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">    fs.<span class="title function_">stat</span>(file, <span class="keyword">function</span>(<span class="params">err, stat</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">fn</span>(err);</span><br><span class="line">      <span class="title function_">fn</span>(<span class="literal">null</span>, stat.<span class="property">size</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> *<span class="title function_">foo</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;.gitignore&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;Makefile&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;package.json&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> [a, b, c];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> *<span class="title function_">bar</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;examples/parallel.js&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;examples/nested.js&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="keyword">yield</span> <span class="title function_">size</span>(<span class="string">&#x27;examples/simple.js&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> [a, b, c];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> results = <span class="keyword">yield</span> [<span class="title function_">foo</span>(), <span class="title function_">bar</span>()];</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(results);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  Or if the generator functions do not require arguments, simply <code>yield</code> the function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> thunkify = <span class="built_in">require</span>(<span class="string">&#x27;thunkify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> get = <span class="title function_">thunkify</span>(request.<span class="property">get</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> *<span class="title function_">results</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">get</span>(<span class="string">&#x27;http://ign.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> [a, b, c]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="comment">// 3 concurrent requests at a time</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> results;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> results;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6 concurrent requests</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">yield</span> [results, results]);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  If a thunk is written to execute immediately you may achieve parallelism<br>  by simply <code>yield</code>-ing <em>after</em> the call. The following are equivalent if<br>  each call kicks off execution immediately:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">size</span>(<span class="string">&#x27;package.json&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">size</span>(<span class="string">&#x27;Readme.md&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">size</span>(<span class="string">&#x27;Makefile&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [<span class="keyword">yield</span> a, <span class="keyword">yield</span> b, <span class="keyword">yield</span> c];</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  Or:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">size</span>(<span class="string">&#x27;package.json&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">size</span>(<span class="string">&#x27;Readme.md&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">size</span>(<span class="string">&#x27;Makefile&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> [a, b, c];</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  You can also pass arguments into the generator. The last argument, <code>done</code>, is<br>  the callback function. Here’s an example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">&#x27;co-exec&#x27;</span>);</span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *(cmd) &#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> <span class="title function_">exec</span>(cmd);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;)(<span class="string">&#x27;pwd&#x27;</span>, done);</span><br></pre></td></tr></table></figure>

<h3 id="yield-array"><a href="#yield-array" class="headerlink" title="yield array"></a>yield array</h3><p>  By yielding an array of thunks you may “join” them all into a single thunk which executes them all concurrently,<br>  instead of in sequence. Note that the resulting array ordering <em>is</em> retained.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">size</span>(<span class="params">file</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">    fs.<span class="title function_">stat</span>(file, <span class="keyword">function</span>(<span class="params">err, stat</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">fn</span>(err);</span><br><span class="line">      <span class="title function_">fn</span>(<span class="literal">null</span>, stat.<span class="property">size</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">size</span>(<span class="string">&#x27;.gitignore&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">size</span>(<span class="string">&#x27;index.js&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">size</span>(<span class="string">&#x27;Makefile&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">yield</span> [a, b, c];</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">  <span class="comment">// =&gt; [ 13, 1687, 129 ]</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>Nested arrays may also be expressed as simple nested arrays:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>),</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>),</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://ign.com&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = [</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>),</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>),</span><br><span class="line">  <span class="title function_">get</span>(<span class="string">&#x27;http://ign.com&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">yield</span> [a, b]);</span><br></pre></td></tr></table></figure>

<h3 id="yield-object"><a href="#yield-object" class="headerlink" title="yield object"></a>yield object</h3><p>  Yielding an object behaves much like yielding an array, however recursion is supported:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> user = <span class="keyword">yield</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">first</span>: <span class="title function_">get</span>(<span class="string">&#x27;name.first&#x27;</span>),</span><br><span class="line">      <span class="attr">last</span>: <span class="title function_">get</span>(<span class="string">&#x27;name.last&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>  Here is the sequential equivalent without yielding an object:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="keyword">var</span> user = &#123;</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">first</span>: <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;name.first&#x27;</span>),</span><br><span class="line">      <span class="attr">last</span>: <span class="keyword">yield</span> <span class="title function_">get</span>(<span class="string">&#x27;name.last&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><p>  On my machine 30,000 sequential stat()s takes an avg of 570ms,<br>  while the same number of sequential stat()s with <code>co()</code> takes<br>  610ms, aka the overhead introduced by generators is <em>extremely</em> negligible.</p>
<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>  MIT</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/package/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/package/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          {"name":"co","version":"3.1.0","description":"generator async flow control goodness","keywords":["async","flow","generator","coro","coroutine"],"devDependencies":{"should":"^3.0.0","mocha":"^1.12.0","bluebird":"^2.0.0","thunkify":"^2.0.0","request":"^2.36.0","matcha":"~0.5.0"},"scripts":{"test":"make test"},"files":["index.js"],"license":"MIT","repository":{"type":"git","url":"https://github.com/visionmedia/co.git"}}
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/index/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
/**
 * slice() reference.
 */

var slice = Array.prototype.slice;

/**
 * Expose `co`.
 */

module.exports = co;

/**
 * Wrap the given generator `fn` and
 * return a thunk.
 *
 * @param {Function} fn
 * @return {Function}
 * @api public
 */

function co(fn) {
  var isGenFun = isGeneratorFunction(fn);

  return function (done) {
    var ctx = this;

    // in toThunk() below we invoke co()
    // with a generator, so optimize for
    // this case
    var gen = fn;

    // we only need to parse the arguments
    // if gen is a generator function.
    if (isGenFun) {
      var args = slice.call(arguments), len = args.length;
      var hasCallback = len && 'function' == typeof args[len - 1];
      done = hasCallback ? args.pop() : error;
      gen = fn.apply(this, args);
    } else {
      done = done || error;
    }

    next();

    // #92
    // wrap the callback in a setImmediate
    // so that any of its errors aren't caught by `co`
    function exit(err, res) {
      setImmediate(function(){
        done.call(ctx, err, res);
      });
    }

    function next(err, res) {
      var ret;

      // multiple args
      if (arguments.length > 2) res = slice.call(arguments, 1);

      // error
      if (err) {
        try {
          ret = gen.throw(err);
        } catch (e) {
          return exit(e);
        }
      }

      // ok
      if (!err) {
        try {
          ret = gen.next(res);
        } catch (e) {
          return exit(e);
        }
      }

      // done
      if (ret.done) return exit(null, ret.value);

      // normalize
      ret.value = toThunk(ret.value, ctx);

      // run
      if ('function' == typeof ret.value) {
        var called = false;
        try {
          ret.value.call(ctx, function(){
            if (called) return;
            called = true;
            next.apply(ctx, arguments);
          });
        } catch (e) {
          setImmediate(function(){
            if (called) return;
            called = true;
            next(e);
          });
        }
        return;
      }

      // invalid
      next(new TypeError('You may only yield a function, promise, generator, array, or object, '
        + 'but the following was passed: "' + String(ret.value) + '"'));
    }
  }
}

/**
 * Convert `obj` into a normalized thunk.
 *
 * @param {Mixed} obj
 * @param {Mixed} ctx
 * @return {Function}
 * @api private
 */

function toThunk(obj, ctx) {

  if (isGeneratorFunction(obj)) {
    return co(obj.call(ctx));
  }

  if (isGenerator(obj)) {
    return co(obj);
  }

  if (isPromise(obj)) {
    return promiseToThunk(obj);
  }

  if ('function' == typeof obj) {
    return obj;
  }

  if (isObject(obj) || Array.isArray(obj)) {
    return objectToThunk.call(ctx, obj);
  }

  return obj;
}

/**
 * Convert an object of yieldables to a thunk.
 *
 * @param {Object} obj
 * @return {Function}
 * @api private
 */

function objectToThunk(obj){
  var ctx = this;
  var isArray = Array.isArray(obj);

  return function(done){
    var keys = Object.keys(obj);
    var pending = keys.length;
    var results = isArray
      ? new Array(pending) // predefine the array length
      : new obj.constructor();
    var finished;

    if (!pending) {
      setImmediate(function(){
        done(null, results)
      });
      return;
    }

    // prepopulate object keys to preserve key ordering
    if (!isArray) {
      for (var i = 0; i < pending; i++) {
        results[keys[i]] = undefined;
      }
    }

    for (var i = 0; i < keys.length; i++) {
      run(obj[keys[i]], keys[i]);
    }

    function run(fn, key) {
      if (finished) return;
      try {
        fn = toThunk(fn, ctx);

        if ('function' != typeof fn) {
          results[key] = fn;
          return --pending || done(null, results);
        }

        fn.call(ctx, function(err, res){
          if (finished) return;

          if (err) {
            finished = true;
            return done(err);
          }

          results[key] = res;
          --pending || done(null, results);
        });
      } catch (err) {
        finished = true;
        done(err);
      }
    }
  }
}

/**
 * Convert `promise` to a thunk.
 *
 * @param {Object} promise
 * @return {Function}
 * @api private
 */

function promiseToThunk(promise) {
  return function(fn){
    promise.then(function(res) {
      fn(null, res);
    }, fn);
  }
}

/**
 * Check if `obj` is a promise.
 *
 * @param {Object} obj
 * @return {Boolean}
 * @api private
 */

function isPromise(obj) {
  return obj && 'function' == typeof obj.then;
}

/**
 * Check if `obj` is a generator.
 *
 * @param {Mixed} obj
 * @return {Boolean}
 * @api private
 */

function isGenerator(obj) {
  return obj && 'function' == typeof obj.next && 'function' == typeof obj.throw;
}

/**
 * Check if `obj` is a generator function.
 *
 * @param {Mixed} obj
 * @return {Boolean}
 * @api private
 */

function isGeneratorFunction(obj) {
  return obj && obj.constructor && 'GeneratorFunction' == obj.constructor.name;
}

/**
 * Check for plain object.
 *
 * @param {Mixed} val
 * @return {Boolean}
 * @api private
 */

function isObject(val) {
  return val && Object == val.constructor;
}

/**
 * Throw `err` in a new stack.
 *
 * This is used when co() is invoked
 * without supplying a callback, which
 * should only be for demonstrational
 * purposes.
 *
 * @param {Error} err
 * @api private
 */

function error(err) {
  if (!err) return;
  setImmediate(function(){
    throw err;
  });
}

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/History/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/History/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="3-1-0-2014-06-30"><a href="#3-1-0-2014-06-30" class="headerlink" title="3.1.0 / 2014-06-30"></a>3.1.0 / 2014-06-30</h1><ul>
<li>remove <code>setImmediate()</code> shim for node 0.8. semi-backwards breaking.<br>Users are expected to shim themselves. Also returns CommonJS browser support.</li>
<li>added key order preservation for objects. thanks @greim</li>
<li>replace <code>q</code> with <code>bluebird</code> in benchmarks and tests</li>
</ul>
<h1 id="3-0-6-2014-05-03"><a href="#3-0-6-2014-05-03" class="headerlink" title="3.0.6 / 2014-05-03"></a>3.0.6 / 2014-05-03</h1><ul>
<li>add <code>setImmediate()</code> fallback to <code>process.nextTick</code></li>
<li>remove duplicate code in toThunk</li>
<li>update thunkify</li>
</ul>
<h1 id="3-0-5-2014-03-17"><a href="#3-0-5-2014-03-17" class="headerlink" title="3.0.5 / 2014-03-17"></a>3.0.5 / 2014-03-17</h1><ul>
<li>fix object/array test failure which tries to enumerate dates. Closes #98</li>
<li>fix final callback error propagation. Closes #92</li>
</ul>
<h1 id="3-0-4-2014-02-17"><a href="#3-0-4-2014-02-17" class="headerlink" title="3.0.4 / 2014-02-17"></a>3.0.4 / 2014-02-17</h1><ul>
<li>fix toThunk object check regression. Closes #89</li>
</ul>
<h1 id="3-0-3-2014-02-08"><a href="#3-0-3-2014-02-08" class="headerlink" title="3.0.3 / 2014-02-08"></a>3.0.3 / 2014-02-08</h1><ul>
<li>refactor: arrayToThunk @AutoSponge #88</li>
</ul>
<h1 id="3-0-2-2014-01-01"><a href="#3-0-2-2014-01-01" class="headerlink" title="3.0.2 / 2014-01-01"></a>3.0.2 / 2014-01-01</h1><ul>
<li>fixed: nil arguments replaced with error fn</li>
</ul>
<h1 id="3-0-1-2013-12-19"><a href="#3-0-1-2013-12-19" class="headerlink" title="3.0.1 / 2013-12-19"></a>3.0.1 / 2013-12-19</h1><ul>
<li>fixed: callback passed as an argument to generators</li>
</ul>
<h1 id="3-0-0-2013-12-19"><a href="#3-0-0-2013-12-19" class="headerlink" title="3.0.0 / 2013-12-19"></a>3.0.0 / 2013-12-19</h1><ul>
<li>fixed: callback passed as an argument to generators</li>
<li>change: <code>co(function *()&#123;&#125;)</code> now returns a reusable thunk</li>
<li>change: <code>this</code> must now be passed through the returned thunk, ex. <code>co(function *()&#123;&#125;).call(this)</code></li>
<li>fix “generator already finished” errors</li>
</ul>
<h1 id="2-3-0-2013-11-12"><a href="#2-3-0-2013-11-12" class="headerlink" title="2.3.0 / 2013-11-12"></a>2.3.0 / 2013-11-12</h1><ul>
<li>add <code>yield object</code> support</li>
</ul>
<h1 id="2-2-0-2013-11-05"><a href="#2-2-0-2013-11-05" class="headerlink" title="2.2.0 / 2013-11-05"></a>2.2.0 / 2013-11-05</h1><ul>
<li>change: make the <code>isGenerator()</code> function more generic</li>
</ul>
<h1 id="2-1-0-2013-10-21"><a href="#2-1-0-2013-10-21" class="headerlink" title="2.1.0 / 2013-10-21"></a>2.1.0 / 2013-10-21</h1><ul>
<li>add passing of arguments into the generator. closes #33.</li>
</ul>
<h1 id="2-0-0-2013-10-14"><a href="#2-0-0-2013-10-14" class="headerlink" title="2.0.0 / 2013-10-14"></a>2.0.0 / 2013-10-14</h1><ul>
<li>remove callback in favour of thunk-only co(). Closes #30 [breaking change]</li>
<li>remove <code>co.wrap()</code> [breaking change]</li>
</ul>
<h1 id="1-5-2-2013-09-02"><a href="#1-5-2-2013-09-02" class="headerlink" title="1.5.2 / 2013-09-02"></a>1.5.2 / 2013-09-02</h1><ul>
<li>fix: preserve receiver with co.wrap()</li>
</ul>
<h1 id="1-5-1-2013-08-11"><a href="#1-5-1-2013-08-11" class="headerlink" title="1.5.1 / 2013-08-11"></a>1.5.1 / 2013-08-11</h1><ul>
<li>remove setImmediate() usage - ~110% perf increase. Closes #14</li>
</ul>
<h1 id="0-5-0-2013-08-10"><a href="#0-5-0-2013-08-10" class="headerlink" title="0.5.0 / 2013-08-10"></a>0.5.0 / 2013-08-10</h1><ul>
<li>add receiver propagation support</li>
<li>examples: update streams.js example to use <code>http.get()</code> and streams2 API</li>
</ul>
<h1 id="1-4-1-2013-07-01"><a href="#1-4-1-2013-07-01" class="headerlink" title="1.4.1 / 2013-07-01"></a>1.4.1 / 2013-07-01</h1><ul>
<li>fix gen.next(val) for latest v8. Closes #8</li>
</ul>
<h1 id="1-4-0-2013-06-21"><a href="#1-4-0-2013-06-21" class="headerlink" title="1.4.0 / 2013-06-21"></a>1.4.0 / 2013-06-21</h1><ul>
<li>add promise support to joins</li>
<li>add <code>yield generatorFunction</code> support</li>
<li>add <code>yield generator</code> support</li>
<li>add nested join support</li>
</ul>
<h1 id="1-3-0-2013-06-10"><a href="#1-3-0-2013-06-10" class="headerlink" title="1.3.0 / 2013-06-10"></a>1.3.0 / 2013-06-10</h1><ul>
<li>add passing of arguments</li>
</ul>
<h1 id="1-2-1-2013-06-08"><a href="#1-2-1-2013-06-08" class="headerlink" title="1.2.1 / 2013-06-08"></a>1.2.1 / 2013-06-08</h1><ul>
<li>fix join() of zero thunks</li>
</ul>
<h1 id="1-2-0-2013-06-08"><a href="#1-2-0-2013-06-08" class="headerlink" title="1.2.0 / 2013-06-08"></a>1.2.0 / 2013-06-08</h1><ul>
<li>add array yielding support. great suggestion by @domenic</li>
</ul>
<h1 id="1-1-0-2013-06-06"><a href="#1-1-0-2013-06-06" class="headerlink" title="1.1.0 / 2013-06-06"></a>1.1.0 / 2013-06-06</h1><ul>
<li>add promise support</li>
<li>change nextTick to setImmediate</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/component/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          {"name":"co","version":"3.1.0","description":"generator async flow control goodness","keywords":["async","flow","generator","coro","coroutine"],"repo":"visionmedia/co","scripts":["index.js"],"licence":"MIT"}
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/co-3.1.0/benchmark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/co-3.1.0/benchmark/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 18:43:06" itemprop="dateCreated datePublished" datetime="2023-04-20T18:43:06+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2014-07-01 10:48:07" itemprop="dateModified" datetime="2014-07-01T10:48:07+08:00">2014-07-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
var co = require('./');
var bluebird = require('bluebird');


function fun(done) {
  done();
}

function *gen() {

}

function getPromise(val, err) {
  return new bluebird(function (resolve, reject) {
    if (err) reject(err);
    else resolve(val);
  });
}

suite('co()', function(){
  set('mintime', process.env.MINTIME | 0 || 2000)

  bench('promises', function(done){
    co(function *(){
      yield setImmediate;
      yield getPromise(1);
      yield getPromise(2);
      yield getPromise(3);
    })(done);
  })

  bench('thunks', function(done){
    co(function *(){
      yield setImmediate;
      yield fun;
      yield fun;
      yield fun;
    })(done);
  })

  bench('arrays', function(done){
    co(function *(){
      yield setImmediate;
      yield [fun, fun, fun];
    })(done);
  })

  bench('objects', function(done){
    co(function *(){
      yield setImmediate;
      yield {
        a: fun,
        b: fun,
        c: fun
      };
    })(done);
  })

  bench('generators', function(done){
    co(function *(){
      yield setImmediate;
      yield gen();
      yield gen();
      yield gen();
    })(done);
  })

  bench('generators delegated', function(done){
    co(function *(){
      yield setImmediate;
      yield* gen();
      yield* gen();
      yield* gen();
    })(done);
  })

  bench('generator functions', function(done){
    co(function *(){
      yield setImmediate;
      yield gen;
      yield gen;
      yield gen;
    })(done);
  })
})

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/20/51-about-thunk-function/aboutThunkFunction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/51-about-thunk-function/aboutThunkFunction/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-20 13:36:05" itemprop="dateCreated datePublished" datetime="2023-04-20T13:36:05+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-04-21 13:26:33" itemprop="dateModified" datetime="2023-04-21T13:26:33+08:00">2023-04-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          // import thunkify from 'thunkify';

// function test(a, b, callback) {
//   const result = a + b;
//   callback(result);
//   callback(result);
//   callback(result);
// }

// const thunkTest = thunkify(test);
// // thunkTest(1, 2)(console.log);

// function* gen() {
//   const first = yield thunkTest(1, 2);
//   const second = yield thunkTest(3, 4);
// }

// const genTest = gen();
// const genValue = genTest.next();
// genValue.value(function (data) {
//   console.log(data);
//   const genValue1 = genTest.next(data);
//   genValue1.value(function (data1) {
//     console.log(data1);
//     genTest.next(data1);
//   });
// });
// function genFn(fn) {
//   const gen = fn();
//   function next(data) {
//     console.log(data);
//     const genValue = gen.next(data);
//     if (genValue.done) return;
//     genValue.value(next);
//   }
//   next();
// }
// genFn(gen);

import co from 'co';
import fs from 'fs';
// 这里的thunk函数也可以自己实现
function size(file) {
  return function (fn) {
    fs.stat(file, function (err, stat) {
      if (err) return fn(err);
      console.log(`size: ${stat.size}`);
      fn(null, stat.size);
    });
  };
}
co(function* () {
  var a = size('../../../package.json');
  var b = size('../../../yarn.lock');
  return [yield a, yield b];
})();

// import co from 'co';
// co(function* () {
//   var result = yield Promise.resolve(true);
//   // var result = yield Promise.reject('errorInfo');
//   return result;
// })
//   .then(function (value) {
//     console.log(`then: ${value}`);
//   })
//   .catch(function (err) {
//     console.error(err);
//   });

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/19/51-about-thunk-function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/19/51-about-thunk-function/" class="post-title-link" itemprop="url">Thunk函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-04-19 17:00:23" itemprop="dateCreated datePublished" datetime="2023-04-19T17:00:23+08:00">2023-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-04-20 18:24:47" itemprop="dateModified" datetime="2023-04-20T18:24:47+08:00">2023-04-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h6 id="求值策略"><a href="#求值策略" class="headerlink" title="求值策略"></a>求值策略</h6><p>在介绍Thunk函数之前，需要先介绍一下什么叫做求值策略，即函数的参数应该什么时候求值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">num</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> num+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>(<span class="number">2</span>+<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>类似上面这样将一个表达式作为参数传入函数，表达式应该什么时候计算？实际上可以分为两种情况：</p>
<ul>
<li>一种是**传值调用(call by value)**，即表达式在传入函数之前就已经进行了计算，test(2+3)就相当于test(5)，js、C语言、JAVA等语言使用的是这种策略。</li>
<li>一种是**传名调用(call by name)**，即直接将表达式传入函数，只在需要的时候进行表达式的运算，Haskell(哈斯克尔)使用的是这种策略。<br>传值调用比较简单和便于理解，但是在没有用到的时候，先进行了计算，可能造成性能浪费。<h6 id="什么是Thunk函数"><a href="#什么是Thunk函数" class="headerlink" title="什么是Thunk函数"></a>什么是Thunk函数</h6><blockquote>
<p>将表达式参数放到一个临时函数之中，再将这个临时函数传入函数体。这个临时函数就叫做 Thunk 函数。<br>它是”传名调用”的一种实现策略，用来替换某个表达式。</p>
</blockquote>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">num</span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> num+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">testValue</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">2</span>+<span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>(<span class="title function_">testValue</span>());</span><br><span class="line"><span class="comment">// testValue 函数就是Thunk函数</span></span><br></pre></td></tr></table></figure>

<h6 id="JavaScript中的Thunk函数"><a href="#JavaScript中的Thunk函数" class="headerlink" title="JavaScript中的Thunk函数"></a>JavaScript中的Thunk函数</h6><p>在 JavaScript 语言中，Thunk 函数替换的不是表达式，而是多参数函数，将其替换成单参数的版本，且只接受回调函数作为参数。</p>
<p>要点：多参数函数</p>
<ul>
<li>函数接受多个参数</li>
<li>函数的最后一个参数是回调函数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, callback</span>) &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> testThunk = <span class="title class_">Thunk</span>(a, b);</span><br><span class="line"><span class="title function_">testThunk</span>(callback);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Thunk</span> = <span class="keyword">function</span> (<span class="params">a, b</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">callback</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">test</span>(a, b, callback);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的函数经过转换器处理，它变成了一个单参数函数，只接受回调函数作为参数。这个单参数版本，就叫做 Thunk 函数。<br>任何函数，只要参数有回调函数，就能写成 Thunk 函数的形式。下面是一个简单的 Thunk 函数转换器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> toThunk = <span class="keyword">function</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">callback</span>)&#123;</span><br><span class="line">      args.<span class="title function_">push</span>(callback);</span><br><span class="line">      <span class="keyword">return</span> fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>使用上面的转换器之后，可将上述的例子修改为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> testThunk = <span class="title function_">toThunk</span>(test);</span><br><span class="line"><span class="title function_">testThunk</span>(a, b)(callback)</span><br></pre></td></tr></table></figure>

<h6 id="Thunkify模块"><a href="#Thunkify模块" class="headerlink" title="Thunkify模块"></a>Thunkify模块</h6><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/tj/node-thunkify">https://github.com/tj/node-thunkify</a><br>使用举例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> thunkify = <span class="built_in">require</span>(<span class="string">&#x27;thunkify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> read = <span class="title function_">thunkify</span>(fs.<span class="property">readFile</span>);</span><br><span class="line"><span class="title function_">read</span>(<span class="string">&#x27;package.json&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>)(<span class="keyword">function</span>(<span class="params">err, str</span>)&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><em>注意：thunkify中存在一个检查机制，回调函数只运行一次。</em><br><img src="/.io//thunkify.png" alt="thunkify源码"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunkify <span class="keyword">from</span> <span class="string">&#x27;thunkify&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = a + b;</span><br><span class="line">  <span class="title function_">callback</span>(result);</span><br><span class="line">  <span class="title function_">callback</span>(result);</span><br><span class="line">  <span class="title function_">callback</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunkTest = <span class="title function_">thunkify</span>(test);</span><br><span class="line"><span class="title function_">thunkTest</span>(<span class="number">1</span>, <span class="number">2</span>)(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h6 id="Thunk函数的用途"><a href="#Thunk函数的用途" class="headerlink" title="Thunk函数的用途"></a>Thunk函数的用途</h6><p>Thunk函数可以和Generator结合使用，Thunk 函数作为在 Generator 中要迭代的值，通过 co 来对 Generator 进行流程控制。<br>Generator函数中可以使用yield将程序的执行权移出，然后通过Thunk函数的回调函数，再将执行权还给Generator函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunkify <span class="keyword">from</span> <span class="string">&#x27;thunkify&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params">a, b, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = a + b;</span><br><span class="line">  <span class="title function_">callback</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunkTest = <span class="title function_">thunkify</span>(test);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>* <span class="title function_">gen</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="title function_">thunkTest</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">yield</span> <span class="title function_">thunkTest</span>(<span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Thunk函数处理</span></span><br><span class="line"><span class="keyword">const</span> genTest = <span class="title function_">gen</span>();</span><br><span class="line"><span class="keyword">const</span> genValue = genTest.<span class="title function_">next</span>();</span><br><span class="line">genValue.<span class="title function_">value</span>(<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">  <span class="keyword">const</span> genValue1 = genTest.<span class="title function_">next</span>(data);</span><br><span class="line">  genValue1.<span class="title function_">value</span>(<span class="keyword">function</span> (<span class="params">data1</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data1);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改为递归方式调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">genFn</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> gen = <span class="title function_">fn</span>();</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">next</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">const</span> genValue = gen.<span class="title function_">next</span>(data);</span><br><span class="line">    <span class="keyword">if</span> (genValue.<span class="property">done</span>) <span class="keyword">return</span>;</span><br><span class="line">    genValue.<span class="title function_">value</span>(next);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">genFn</span>(gen);</span><br></pre></td></tr></table></figure>

<h6 id="co-Generator-Thunk"><a href="#co-Generator-Thunk" class="headerlink" title="co+Generator+Thunk"></a>co+Generator+Thunk</h6><p>可以通过co控制Generator函数中的Thunk函数的执行流程<br>co地址：<a target="_blank" rel="noopener" href="https://github.com/tj/co">https://github.com/tj/co</a></p>
<p><em>注意：co从4.0.0开始返回的是promise，之前返回的是thunk函数，4.0.0之前会把promise转成thunk函数</em></p>
<p><img src="/.io//promiseToThunk.png" alt="promiseToThunk"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">&#x27;co&#x27;</span>);</span><br><span class="line"><span class="comment">// 这里的thunk函数也可以自己实现</span></span><br><span class="line"><span class="keyword">var</span> thunkify = <span class="built_in">require</span>(<span class="string">&#x27;thunkify&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> get = <span class="title function_">thunkify</span>(request.<span class="property">get</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> *<span class="title function_">results</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="title function_">get</span>(<span class="string">&#x27;http://google.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">var</span> b = <span class="title function_">get</span>(<span class="string">&#x27;http://yahoo.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">var</span> c = <span class="title function_">get</span>(<span class="string">&#x27;http://ign.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">yield</span> [a, b, c]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span> *()&#123;</span><br><span class="line">  <span class="comment">// 3 concurrent requests at a time</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="keyword">yield</span> results;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="keyword">yield</span> results;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 6 concurrent requests</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">yield</span> [results, results]);</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p><img src="/.io//thunkToPromise.png" alt="thunkToPromise"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> co <span class="keyword">from</span> <span class="string">&#x27;co&#x27;</span>;</span><br><span class="line"><span class="title function_">co</span>(<span class="keyword">function</span>* () &#123;</span><br><span class="line">  <span class="keyword">var</span> result = <span class="keyword">yield</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// var result = yield Promise.reject(&#x27;errorInfo&#x27;);</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`then: <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/19/50-try-catch-return/tryCatchReturn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/19/50-try-catch-return/tryCatchReturn/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-04-19 11:06:10 / Modified: 15:32:57" itemprop="dateCreated datePublished" datetime="2023-04-19T11:06:10+08:00">2023-04-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          // function test() {
//   for (let i = 0; i < 4; i++) {
//     console.log(`before: ${i}`);
//     if (i === 2) return;
//     console.log(`after: ${i}`);
//   }
//   console.log(`result`);
// }
// test();
// before: 0
// after: 0
// before: 1
// after: 1
// before: 2

// function test() {
//  return
//  1+2;
// }
// console.log(test());

// try {
//   a + 3;
// } catch (error) {
//   console.log(error);
// }
// ReferenceError: a is not defined

// try {
//   try {
//     try {
//       try {
//         a + 3;
//       } finally {
//       }
//     } finally {
//     }
//   } finally {
//   }
// } catch (err) {
//   console.log(`outer: ${err}`);
// }

// try {
//   // a + 3;
//   test();
// } catch (err) {
//   if (err.toString().includes('not defined')) {
//     console.log(`not defined error: ${err}`);
//   } else {
//     console.log(err);
//   }
// }

// function test() {
//   try {
//     try {
//       a + 3;
//     } catch (err) {
//       console.log(`inner error: ${err}`);
//       return;
//     } finally {
//       console.log(`inner finally`);
//       return;
//     }
//   } finally {
//     console.log(`finally`);
//   }
// }
// test();
// inner error: ReferenceError: a is not defined
// inner finally
// finally

function test() {
  try {
    try {
      return 3;
    } catch (err) {
      console.log(`inner error: ${err}`);
      return;
    } finally {
      // console.log(`inner finally`);
      return 'finally';
    }
  } finally {
    // console.log(`outer finally`);
    return 'outer finally';
  }
}
const result = test();
console.log(result);

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://sunjinkang.github.io/2023/04/19/50-try-catch-return/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Sun Jinkang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sun ...something">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Sun ...something">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/19/50-try-catch-return/" class="post-title-link" itemprop="url">try...catch和return</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-04-19 10:42:04 / Modified: 15:33:37" itemprop="dateCreated datePublished" datetime="2023-04-19T10:42:04+08:00">2023-04-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h6 id="关于return"><a href="#关于return" class="headerlink" title="关于return"></a>关于return</h6><blockquote>
<p>return 语句终止函数的执行，并返回一个指定的值给函数调用者</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`before: <span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (i === <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`after: <span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line"><span class="comment">// before: 0</span></span><br><span class="line"><span class="comment">// after: 0</span></span><br><span class="line"><span class="comment">// before: 1</span></span><br><span class="line"><span class="comment">// after: 1</span></span><br><span class="line"><span class="comment">// before: 2</span></span><br></pre></td></tr></table></figure>
<p>注意：自动分号补全规则会影响 return 语句。在 return 关键字和被返回的表达式之间不允许使用换行符。</p>
<p><em>自动分号补全(ASI)</em><br>在JavaScript中，行尾的分号有一种自动插入机制，如果新起了一行，并且这新的一行不能追加到当前语句时，会自动追加一个分号</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="number">1</span>;</span><br><span class="line"><span class="comment">// return会因为自动分号补全自动添加一个分号</span></span><br></pre></td></tr></table></figure>

<h6 id="关于try…catch"><a href="#关于try…catch" class="headerlink" title="关于try…catch"></a>关于try…catch</h6><blockquote>
<p>try…catch 语句标记要尝试的语句块，并指定一个出现异常时抛出的响应。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  a + <span class="number">3</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure>
<ul>
<li>try…catch语法<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> try_statements</span><br><span class="line">&#125;</span><br><span class="line">[<span class="keyword">catch</span> (exception_var_1 <span class="keyword">if</span> condition_1) &#123; <span class="comment">// non-standard</span></span><br><span class="line">   catch_statements_1</span><br><span class="line">&#125;]</span><br><span class="line">...</span><br><span class="line">[<span class="keyword">catch</span> (exception_var_2) &#123;</span><br><span class="line">   catch_statements_2</span><br><span class="line">&#125;]</span><br><span class="line">[<span class="keyword">finally</span> &#123;</span><br><span class="line">   finally_statements</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure></li>
<li>使用方式<ul>
<li>try…catch</li>
<li>try…finally</li>
<li>try…catch…finally<br>catch子句包含try块中抛出异常时要执行的语句。如果在try块中有任何一个语句（或者从try块中调用的函数）抛出异常，控制立即转向catch子句。如果在try块中没有异常抛出，会跳过catch子句。</li>
</ul>
</li>
</ul>
<p>finally子句在try块和catch块之后执行但是在下一个try声明之前执行。无论是否有异常抛出或捕获它总是执行。</p>
<p><em>你可以嵌套一个或者更多的try语句。如果内部的try语句没有catch子句，那么将会进入包裹它的try语句的catch子句。</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    a + <span class="number">3</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`outer: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// inner: ReferenceError: a is not defined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    a + <span class="number">3</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span>&#123;&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`outer: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// outer: ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure>

<ul>
<li>无条件的catch语句<br>即catch捕获错误，进行处理，常用的一般是这种，不再赘述</li>
<li>有条件的catch语句<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  a + <span class="number">3</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err.<span class="title function_">toString</span>().<span class="title function_">includes</span>(<span class="string">&#x27;not defined&#x27;</span>)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`not defined error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// not defined error: ReferenceError: a is not defined</span></span><br></pre></td></tr></table></figure>
<h6 id="try…catch中使用return"><a href="#try…catch中使用return" class="headerlink" title="try…catch中使用return"></a>try…catch中使用return</h6></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">   a+<span class="number">3</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`finally`</span>)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line"><span class="comment">// inner error: ReferenceError: a is not defined</span></span><br><span class="line"><span class="comment">// finally</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      a + <span class="number">3</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner finally`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`finally`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line"><span class="comment">// inner error: ReferenceError: a is not defined</span></span><br><span class="line"><span class="comment">// inner finally</span></span><br><span class="line"><span class="comment">// finally</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner finally`</span>);</span><br><span class="line">      <span class="comment">// return &#x27;finally&#x27;;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`outer finally`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">test</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"><span class="comment">// inner finally</span></span><br><span class="line"><span class="comment">// outer finally</span></span><br><span class="line"><span class="comment">// if inner finally not return something, result is 3, else result is the inner finally return.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`inner error: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;finally&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;outer finally&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> result = <span class="title function_">test</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"><span class="comment">// outer finally</span></span><br></pre></td></tr></table></figure>

<p><em>如果从finally块中返回一个值，那么这个值将会成为整个try-catch-finally的返回值，无论是否有return语句在try和catch中。这包括在catch块里抛出的异常。</em></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/default-index/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/default-index/">1</a><a class="page-number" href="/default-index/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/default-index/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/default-index/page/9/">9</a><a class="extend next" rel="next" href="/default-index/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sun Jinkang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
